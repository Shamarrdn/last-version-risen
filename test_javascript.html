<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار JavaScript</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #console-output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 اختبار JavaScript</h1>
        <p>هذا الملف لاختبار الكود JavaScript المستخدم في النماذج</p>
        
        <div class="test-section">
            <h3>1. اختبار المتغيرات العامة</h3>
            <button onclick="testVariables()">اختبار المتغيرات</button>
            <div id="variables-result"></div>
        </div>
        
        <div class="test-section">
            <h3>2. اختبار دالة prepareFormData</h3>
            <button onclick="testPrepareFormData()">اختبار إعداد البيانات</button>
            <div id="prepare-result"></div>
        </div>
        
        <div class="test-section">
            <h3>3. اختبار دالة debugFormData</h3>
            <button onclick="testDebugFormData()">اختبار التشخيص</button>
            <div id="debug-result"></div>
        </div>
        
        <div class="test-section">
            <h3>4. اختبار DOM Elements</h3>
            <button onclick="testDOMElements()">اختبار عناصر DOM</button>
            <div id="dom-result"></div>
        </div>
        
        <div class="test-section">
            <h3>5. Console Output</h3>
            <button onclick="clearConsole()">مسح Console</button>
            <div id="console-output"></div>
        </div>
    </div>

    <script>
        // محاكاة المتغيرات العامة المستخدمة في النماذج
        let selectedSizes = [];
        let availableSizes = [
            { id: 1, name: 'مقاس صغير' },
            { id: 2, name: 'مقاس متوسط' },
            { id: 3, name: 'مقاس كبير' }
        ];
        let availableColors = [
            { id: 1, name: 'أحمر', code: '#FF0000' },
            { id: 2, name: 'أزرق', code: '#0000FF' },
            { id: 3, name: 'أخضر', code: '#00FF00' }
        ];

        // محاكاة دالة prepareFormData
        function prepareFormData() {
            console.log('🔍 [DEBUG] Preparing form data...');
            console.log('Selected sizes:', selectedSizes);
            
            // محاكاة النموذج
            const form = document.createElement('form');
            
            // إضافة بعض البيانات التجريبية
            selectedSizes = [
                {
                    id: 1,
                    name: 'مقاس صغير',
                    colors: [
                        { id: 1, name: 'أحمر', stock: 10, price: 100 }
                    ]
                }
            ];
            
            // إزالة البيانات القديمة
            const oldInputs = form.querySelectorAll('input[name^="selected_sizes"], input[name^="selected_colors"], input[name^="stock["], input[name^="price["]');
            oldInputs.forEach(input => {
                console.log('Removing old input:', input.name, input.value);
                input.remove();
            });
            
            // جمع البيانات من selectedSizes
            const collectedSizes = new Set();
            const collectedColors = new Set();
            const collectedStockData = {};
            const collectedPriceData = {};
            
            selectedSizes.forEach(size => {
                collectedSizes.add(size.id);
                
                size.colors.forEach(color => {
                    collectedColors.add(color.id);
                    
                    if (!collectedStockData[size.id]) collectedStockData[size.id] = {};
                    if (!collectedPriceData[size.id]) collectedPriceData[size.id] = {};
                    
                    collectedStockData[size.id][color.id] = color.stock;
                    collectedPriceData[size.id][color.id] = color.price;
                });
            });
            
            // إضافة الحقول المخفية
            Array.from(collectedSizes).forEach(sizeId => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'selected_sizes[]';
                input.value = sizeId;
                form.appendChild(input);
                console.log('Added size input:', sizeId);
            });
            
            Array.from(collectedColors).forEach(colorId => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'selected_colors[]';
                input.value = colorId;
                form.appendChild(input);
                console.log('Added color input:', colorId);
            });
            
            Object.keys(collectedStockData).forEach(sizeId => {
                Object.keys(collectedStockData[sizeId]).forEach(colorId => {
                    const stockValue = collectedStockData[sizeId][colorId];
                    const priceValue = collectedPriceData[sizeId][colorId];
                    
                    const stockInput = document.createElement('input');
                    stockInput.type = 'hidden';
                    stockInput.name = `stock[${sizeId}][${colorId}]`;
                    stockInput.value = stockValue;
                    form.appendChild(stockInput);
                    
                    const priceInput = document.createElement('input');
                    priceInput.type = 'hidden';
                    priceInput.name = `price[${sizeId}][${colorId}]`;
                    priceInput.value = priceValue;
                    form.appendChild(priceInput);
                });
            });
            
            console.log('✅ Form data prepared successfully');
            return true;
        }

        // محاكاة دالة debugFormData
        function debugFormData() {
            console.log('🔍 === تشخيص البيانات ===');
            console.log('selectedSizes:', selectedSizes);
            console.log('availableSizes:', availableSizes);
            console.log('availableColors:', availableColors);
            
            const form = document.createElement('form');
            
            // إضافة بعض الحقول التجريبية
            const sizeInput = document.createElement('input');
            sizeInput.name = 'selected_sizes[]';
            sizeInput.value = '1';
            form.appendChild(sizeInput);
            
            const colorInput = document.createElement('input');
            colorInput.name = 'selected_colors[]';
            colorInput.value = '1';
            form.appendChild(colorInput);
            
            const stockInput = document.createElement('input');
            stockInput.name = 'stock[1][1]';
            stockInput.value = '10';
            form.appendChild(stockInput);
            
            const selectedSizesInputs = form.querySelectorAll('input[name="selected_sizes[]"]');
            const selectedColorsInputs = form.querySelectorAll('input[name="selected_colors[]"]');
            const stockInputs = form.querySelectorAll('input[name*="stock["]');
            const priceInputs = form.querySelectorAll('input[name*="price["]');
            
            console.log('🔍 Inputs found:');
            console.log('- selected_sizes[]:', selectedSizesInputs.length);
            console.log('- selected_colors[]:', selectedColorsInputs.length);
            console.log('- stock inputs:', stockInputs.length);
            console.log('- price inputs:', priceInputs.length);
            
            return {
                sizes: selectedSizesInputs.length,
                colors: selectedColorsInputs.length,
                stock: stockInputs.length,
                price: priceInputs.length
            };
        }

        // دالة اختبار المتغيرات
        function testVariables() {
            const result = document.getElementById('variables-result');
            try {
                if (typeof selectedSizes !== 'undefined' && Array.isArray(selectedSizes)) {
                    result.innerHTML = '<div class="success">✅ المتغيرات العامة معرفة بشكل صحيح</div>';
                    console.log('✅ المتغيرات العامة تعمل بشكل صحيح');
                } else {
                    result.innerHTML = '<div class="error">❌ مشكلة في تعريف المتغيرات العامة</div>';
                    console.error('❌ مشكلة في تعريف المتغيرات العامة');
                }
            } catch (error) {
                result.innerHTML = `<div class="error">❌ خطأ: ${error.message}</div>`;
                console.error('❌ خطأ في اختبار المتغيرات:', error);
            }
        }

        // دالة اختبار prepareFormData
        function testPrepareFormData() {
            const result = document.getElementById('prepare-result');
            try {
                const success = prepareFormData();
                if (success) {
                    result.innerHTML = '<div class="success">✅ دالة prepareFormData تعمل بشكل صحيح</div>';
                    console.log('✅ دالة prepareFormData تعمل بشكل صحيح');
                } else {
                    result.innerHTML = '<div class="error">❌ دالة prepareFormData فشلت</div>';
                    console.error('❌ دالة prepareFormData فشلت');
                }
            } catch (error) {
                result.innerHTML = `<div class="error">❌ خطأ: ${error.message}</div>`;
                console.error('❌ خطأ في دالة prepareFormData:', error);
            }
        }

        // دالة اختبار debugFormData
        function testDebugFormData() {
            const result = document.getElementById('debug-result');
            try {
                const debugResult = debugFormData();
                result.innerHTML = `<div class="success">✅ دالة debugFormData تعمل بشكل صحيح<br>
                النتائج: المقاسات=${debugResult.sizes}, الألوان=${debugResult.colors}, المخزون=${debugResult.stock}, الأسعار=${debugResult.price}</div>`;
                console.log('✅ دالة debugFormData تعمل بشكل صحيح');
            } catch (error) {
                result.innerHTML = `<div class="error">❌ خطأ: ${error.message}</div>`;
                console.error('❌ خطأ في دالة debugFormData:', error);
            }
        }

        // دالة اختبار DOM Elements
        function testDOMElements() {
            const result = document.getElementById('dom-result');
            try {
                // اختبار إنشاء عناصر DOM
                const testDiv = document.createElement('div');
                testDiv.className = 'test-element';
                testDiv.innerHTML = 'عنصر تجريبي';
                
                const testInput = document.createElement('input');
                testInput.type = 'hidden';
                testInput.name = 'test_input';
                testInput.value = 'test_value';
                
                if (testDiv && testInput) {
                    result.innerHTML = '<div class="success">✅ إنشاء عناصر DOM يعمل بشكل صحيح</div>';
                    console.log('✅ إنشاء عناصر DOM يعمل بشكل صحيح');
                } else {
                    result.innerHTML = '<div class="error">❌ مشكلة في إنشاء عناصر DOM</div>';
                    console.error('❌ مشكلة في إنشاء عناصر DOM');
                }
            } catch (error) {
                result.innerHTML = `<div class="error">❌ خطأ: ${error.message}</div>`;
                console.error('❌ خطأ في اختبار DOM Elements:', error);
            }
        }

        // دالة مسح Console
        function clearConsole() {
            document.getElementById('console-output').textContent = '';
        }

        // اعتراض console.log لعرض الرسائل في الصفحة
        const originalLog = console.log;
        const originalError = console.error;
        const consoleOutput = document.getElementById('console-output');

        console.log = function(...args) {
            originalLog.apply(console, args);
            consoleOutput.textContent += args.join(' ') + '\n';
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            consoleOutput.textContent += '❌ ERROR: ' + args.join(' ') + '\n';
        };

        // تشغيل الاختبارات عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔍 بدء اختبار JavaScript...');
            console.log('✅ الصفحة محملة بنجاح');
            
            // اختبار تلقائي للمتغيرات
            setTimeout(() => {
                testVariables();
            }, 500);
        });
    </script>
</body>
</html>
